extends layout

block content
  .container.my-5
    .row.justify-content-center
      .col-md-6
        select#movieLimit.form-select
          option(value="0") Show all
          option(value="4") Show 4
          option(value="8") Show 8
          option(value="16") Show 16
          option(value="32") Show 32
          option(value="64") Show 64
      .col-md-6
        input#movieSearch.form-control(type="text", placeholder="Search movies...")
            
  .container
    .row.row-cols-1.row-cols-sm-2.row-cols-md-3.row-cols-lg-4.g-4
      each movie in movies
        .col
          .card.h-100
            img.card-img-top(src="/images/Bombardiro_Crocodillo.jpg", alt=movie.title)
            .card-body
              h5.card-title= movie.title
            .card-footer.text-center
              button.btn.btn-primary(type="button", data-bs-toggle="modal", data-bs-target=`#movieModal-${movie.film_id}`)
                View Details
              
              // NEW CODE: The favorite button is added here
              if user
                button.btn.favorite-btn(
                  class=movie.isFavorite ? 'btn-danger' : 'btn-success',
                  data-movie-id=movie.film_id,
                  data-is-favorite=movie.isFavorite
                )
                  if movie.isFavorite
                    | Remove from Favorites
                  else
                    | Add to Favorites
                
            // Modal per film
            .modal.fade(id=`movieModal-${movie.film_id}`, tabindex="-1")
              .modal-dialog
                .modal-content.text-bg-dark.text-white
                  .modal-header
                    h5.modal-title= movie.title
                    button.btn-close(type="button", data-bs-dismiss="modal", aria-label="Close")
                  .modal-body.text-start
                    if movie.release_year
                      p Released: #{movie.release_year}
                    if movie.description
                      p= movie.description
                    else
                      p No description available.
                  .modal-footer
                    button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Close


  block scripts
  script.
    document.addEventListener('DOMContentLoaded', () => {
      // Existing search/filter logic
      const searchInput = document.getElementById('movieSearch');
      const limitSelect = document.getElementById('movieLimit');
      const cardCols = document.querySelectorAll('.col');

      function filterMovies() {
        const query = searchInput.value.toLowerCase();
        const limit = parseInt(limitSelect.value, 10);
        let shown = 0;

        cardCols.forEach(col => {
          const title = col.querySelector('.card-title')?.textContent.toLowerCase() || '';
          const matchesQuery = title.includes(query);
          const withinLimit = limit === 0 || shown < limit;

          if (matchesQuery && withinLimit) {
            col.style.display = 'block';
            shown++;
          } else {
            col.style.display = 'none';
          }
        });
      }

      searchInput.addEventListener('input', filterMovies);
      limitSelect.addEventListener('change', filterMovies);
      
      filterMovies();

      // NEW CODE: JavaScript for the favorite buttons
      const favoriteButtons = document.querySelectorAll('.favorite-btn');
      favoriteButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
          const movieId = e.target.dataset.movieId;
          const isFavorite = e.target.dataset.isFavorite === 'true';

          const url = `/movies/favorite/${movieId}`;
          const method = isFavorite ? 'DELETE' : 'POST';

          try {
            const response = await fetch(url, { method });
            if (response.ok) {
              const newIsFavorite = !isFavorite;
              e.target.dataset.isFavorite = newIsFavorite;
              e.target.textContent = newIsFavorite ? 'Remove from Favorites' : 'Add to Favorites';
              e.target.classList.toggle('btn-success', !newIsFavorite);
              e.target.classList.toggle('btn-danger', newIsFavorite);
            } else {
              alert('An error occurred. Please try again.');
            }
          } catch (error) {
            console.error('Fetch error:', error);
            alert('An unexpected error occurred: ' + error.message);
          }
        });
      });
    });
    